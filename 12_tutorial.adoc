[[chapter-tutorial]]
:docinfo: shared
:toc: left
:toclevels: 3
:sectnums:
:copyright: Open Logistics Foundation License 1.3

= Tutorial

This chapter offers a detailed, step-by-step guide for setting up the components of {projectName}.
Designed to provide clear instructions and essential information, this tutorial aims to ensure a smooth and efficient installation process.
Follow along to get your application up and running with ease.

Attention: The smart contracts will be deployed to an in-process blockchain for development purposes.
This means all data will be lost when the blockchain is stopped.

== Prerequisites

Properly preparing your environment is crucial for a successful installation and usage of {projectName}.
This section outlines the key prerequisites necessary for a smooth setup.
Following these guidelines will enhance your installation experience.
Note: The commands and procedures described in this guide have been successfully tested on an Ubuntu operating system.

=== Installing Git

Git is essential for version control and managing updates from the Open Logistics Foundation GitLab repository.

If Git is not yet installed on your system, follow these steps:

1. *Visit* https://git-scm.com/downloads[Git's official website] to download Git for your operating system.
2. *Follow* the installation instructions on the website.
3. *Verify* the installation with this command:

[source,shell]
git --version

=== Installing Node.js

Node.js is a JavaScript runtime that allows you to run JavaScript code outside of a web browser.
It is also used to install and manage the dependencies of the blockchain connector and the smart contracts.

If Node.js is not yet installed on your system, follow these steps:

1. *Visit* https://nodejs.org/en/download/[Node.js's official website] to download Node.js 20 for your operating system.
2. *Follow* the installation instructions on the website.
3. *Verify* the installation with these commands:

[source,shell]
node --version
npm --version

=== Cloning the Codebases

TODO: replace these Fraunhofer URLs with OLF URLs before mirroring

The GitLab subgroup for {projectName} is available on the [Fraunhofer GitLab](https://gitlab.cc-asp.fraunhofer.de/silicon-economy/base/blockchainbroker/ethereum/projects/nft-folder).
It contains three different projects: `Blockchain Connector`, `Smart Contracts`, and `Documentation`.
The `Documentation` project is where you are currently reading this documentation.
The `Smart Contracts` project contains the Solidity smart contracts, and the `Blockchain Connector` project contains the TypeScript code for the blockchain connector.

1. *Clone* the `Smart Contract` repository using this command:
[source,shell]
git clone git@gitlab.cc-asp.fraunhofer.de:silicon-economy/base/blockchainbroker/ethereum/projects/nft-folder/smart-contracts.git

2. *Create* a new project as project-specific Blockchain Connector (e.g. with Nest.js) und f√ºge die Blockchain Connector library als npm package hinzu
[source,shell]
npm install @nft-folder/blockchain-connector

== Deploying the Smart Contracts

The smart contracts are deployed to the blockchain using Hardhat.
This development environment helps developers manage the lifecycle of their smart contracts and provides a comprehensive environment for compiling, testing and deploying them.
For our purposes, we deploy the smart contracts to the Hardhat Network, a local Ethereum network.

Perform the following steps to start the Hardhat Network and deploy the smart contracts to it:

1. *Navigate* to the `smart-contracts` directory:
[source,shell]
cd smart-contracts

2. *Rename* the `.env.example` file to `.env`:
[source,shell]
mv .env.example .env

3. *Install* the dependencies:
[source,shell]
npm install

4. *Compile* the smart contracts:
[source,shell]
npm run compile

5. *Start* the Hardhat Network:
[source,shell]
npm run blockchain:start

6. *Deploy* the Container smart contract to the Hardhat Network:
[source,shell]
npm run local:deploy-container

7. *Deploy* the Token smart contract to the Hardhat Network:
[source,shell]
npm run local:deploy-token

8. *Copy* the addresses of the deployed smart contracts from the terminal output and save them for later use

== Running the project-specific Blockchain Connector

The following section is an example of a project-specific blockchain connector as a Nest.js microservice.

The project-specific blockchain connector is a TypeScript application that connects to the blockchain via the imported Blockchain Connector library.
This application can run either directly on the host machine through Node.js or within a Docker container using Docker Compose.

=== Running the Blockchain Connector on the Host Machine

Perform the following steps to run the blockchain connector on the host machine:

1. *Navigate* to the `blockchain-connector` directory:
[source,shell]
cd ../blockchain-connector

2. *Rename* the `.env.example` file to `.env`:
[source,shell]
mv .env.example .env

3. *Ensure* that the `CONTAINER_ADDRESS` and `TOKEN_ADDRESS` values in the `.env` file are set to the saved addresses of the deployed smart contracts from the previous section and that the entries for `CONTAINER_ABI`, `SEGMENT_ABI` and `TOKEN_ABI` also correspond to the ABIs of the deployed smart contract versions.

4. *Install* the dependencies:
[source,shell]
npm install

5. *Start* the blockchain connector:
[source,shell]
npm run start

=== Running the Blockchain Connector in a Docker Container

Perform the following steps to run the blockchain connector in a Docker container:

1. *Navigate* to the `blockchain-connector` directory:
[source,shell]
cd ../blockchain-connector

2. *Rename* the `.env.example` file to `.env`:
[source,shell]
mv .env.example .env

3. *Ensure* that the `CONTAINER_ADDRESS` and `TOKEN_ADDRESS` values in the `.env` file are set to the saved addresses of the deployed smart contracts from the previous section and that the entries for `CONTAINER_ABI`, `SEGMENT_ABI` and `TOKEN_ABI` also correspond to the ABIs of the deployed smart contract versions.

4. *Install* the dependencies:
[source,shell]
npm install

5. *Build* the artifact:
[source,shell]
npm run build

6. *Build* the Docker image and start the Docker container:
[source,shell]
docker compose up

== Testing Communication between the project-specific Blockchain Connector and the Smart Contracts

To verify that the blockchain connector is successfully communicating with the smart contracts, perform the following steps. (To do this, the ENABLE_DEBUG_CONTROLLER flag in the env. file must be set to true)

1. *Open* a web browser and navigate to `http://localhost:3000/api`
2. *Click* on the `POST /tokens` endpoint to create a new token
3. *Enter* the following JSON object in the request body:
[source,json]
    {
        "remoteId": "dummy-1337",
        "asset": {
            "uri": "https://example.com/dummy-1337/image.jpg",
            "hash": "abcdef1234567890"
        },
        "metadata": {
            "uri": "https://example.com/dummy-1337/metadata.json",
            "hash": "1234567890abcdef"
        },
        "additionalInformation": "Lorem ipsum dolor sit amet"
    }

4. *Click* on the `Try it out` button to send the request
5. *Click* on the `GET /tokens` endpoint to retrieve the token
6. *Enter* the following value in the `remoteId` field: `dummy-1337`
7. *Click* on the `Try it out` button to send the request
8. *Verify* that the response contains a JSON object similar to the following:
[source,json]
    {
    "remoteId": "dummy-1337",
    "asset": {
        "uri": "https://example.com/dummy-1337/image.jpg",
        "hash": "abcdef1234567890"
    },
    "metadata": {
        "uri": "https://example.com/dummy-1337/metadata.json",
        "hash": "1234567890abcdef"
    },
    "additionalInformation": "Lorem ipsum dolor sit amet",
    "ownerAddress": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
    "minterAddress": "0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",
    "createdOn": "2024-01-01T10:00:00.000Z",
    "lastUpdatedOn": "2024-01-01T10:00:00.000Z",
    "tokenId": "0",
    "tokenAddress": "0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512"
    }
